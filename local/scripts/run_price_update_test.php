<?php
// ======================================================================
// –§–∞–π–ª: /local/scripts/run_price_update_test.php
// –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–∞—Ä—Å–µ—Ä–∞ —Ü–µ–Ω –∏–∑ Google Sheets
// ======================================================================
// 
// –ù–ê–ó–ù–ê–ß–ï–ù–ò–ï:
// –ü–æ–∑–≤–æ–ª—è–µ—Ç –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å –∞–≥–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
// 
// –§–£–ù–ö–¶–ò–û–ù–ê–õ–¨–ù–û–°–¢–¨ –ü–ê–†–°–ï–†–ê:
// - statusdownload = TRUE  ‚Üí –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ/–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã
// - statusdownload = FALSE ‚Üí —É–¥–∞–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∏–∑ –±–∞–∑—ã
// - –¥—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è        ‚Üí –ø—Ä–æ–ø—É—Å–∫ —Å—Ç—Ä–æ–∫–∏
//
// –ö–ê–ö –ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨:
// –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –≤ –±—Ä–∞—É–∑–µ—Ä–µ: http://–≤–∞—à-—Å–∞–π—Ç.ru/local/scripts/run_price_update_test.php
// –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤!
// ======================================================================

require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/prolog_before.php");

global $USER;
if (!$USER || !$USER->IsAdmin()) {
    die("‚õî –î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–ï–ù. –¢–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.");
}

// –ü–æ–¥–∫–ª—é—á–∞–µ–º —Ñ–∞–π–ª —Å —Ñ—É–Ω–∫—Ü–∏–µ–π –∞–≥–µ–Ω—Ç–∞
require_once($_SERVER["DOCUMENT_ROOT"] . "/local/scripts/update_prices_from_google.php");

if (function_exists("UpdatePricesAgent")) {
    echo "<pre style='font-family: monospace; background: #f5f5f5; padding: 20px; border-radius: 5px;'>";
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n";
    echo "‚ïë     –†–£–ß–ù–û–ô –ó–ê–ü–£–°–ö –û–ë–ù–û–í–õ–ï–ù–ò–Ø –¶–ï–ù –ò–ó GOOGLE SHEETS             ‚ïë\n";
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n\n";
    echo "üïê –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞: " . date("d.m.Y H:i:s") . "\n";
    echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " . $USER->GetLogin() . " (ID: " . $USER->GetID() . ")\n";
    echo "\nüöÄ –ó–∞–ø—É—Å–∫ –ø–∞—Ä—Å–µ—Ä–∞...\n";
    echo str_repeat("-", 64) . "\n\n";
    
    $startTime = microtime(true);
    UpdatePricesAgent(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∞–≥–µ–Ω—Ç–∞
    $endTime = microtime(true);
    $executionTime = round($endTime - $startTime, 2);
    
    echo "\n" . str_repeat("=", 64) . "\n";
    echo "‚úÖ –í–´–ü–û–õ–ù–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û\n";
    echo str_repeat("=", 64) . "\n";
    echo "‚è± –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {$executionTime} —Å–µ–∫.\n";
    echo "üìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–π –ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤: /update_prices.log\n\n";
    
    // –í—ã–≤–æ–¥–∏–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ª–æ–≥-—Ñ–∞–π–ª–∞
    $logPath = $_SERVER['DOCUMENT_ROOT'] . '/update_prices.log';
    if (file_exists($logPath)) {
        echo str_repeat("=", 64) . "\n";
        echo "üìã –°–û–î–ï–†–ñ–ò–ú–û–ï –õ–û–ì-–§–ê–ô–õ–ê:\n";
        echo str_repeat("=", 64) . "\n";
        $logContent = file_get_contents($logPath);
        echo htmlspecialchars($logContent);
    } else {
        echo "‚ö†Ô∏è  –õ–æ–≥-—Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –ø—É—Ç–∏: {$logPath}\n";
    }
    
    echo "\n" . str_repeat("=", 64) . "\n";
    echo "üí° –°–ü–†–ê–í–ö–ê:\n";
    echo "  ‚Ä¢ –¢–æ–≤–∞—Ä—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º TRUE - —Ü–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã\n";
    echo "  ‚Ä¢ –¢–æ–≤–∞—Ä—ã —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º FALSE - —Ü–µ–Ω—ã —É–¥–∞–ª–µ–Ω—ã –∏–∑ –±–∞–∑—ã\n";
    echo "  ‚Ä¢ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã - –ø—Ä–æ–ø—É—â–µ–Ω—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π\n";
    echo str_repeat("=", 64) . "\n";
    echo "</pre>";
} else {
    echo "<pre style='font-family: monospace; background: #ffebee; padding: 20px; border-radius: 5px; color: #c62828;'>";
    echo "‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê!\n\n";
    echo "–§—É–Ω–∫—Ü–∏—è UpdatePricesAgent() –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.\n\n";
    echo "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n";
    echo "  1. –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ñ–∞–π–ª: /local/scripts/update_prices_from_google.php\n";
    echo "  2. –°–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–Ω —Ñ—É–Ω–∫—Ü–∏—é UpdatePricesAgent()\n";
    echo "  3. –ö–æ—Ä—Ä–µ–∫—Ç–µ–Ω –ª–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å PHP –≤ —ç—Ç–æ–º —Ñ–∞–π–ª–µ\n";
    echo "</pre>";
}

require($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/include/epilog_after.php");
?>