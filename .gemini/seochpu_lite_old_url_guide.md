# Пошаговая инструкция: Как определить "Старую ссылку" для модуля SEO фильтра

## ВАЖНО: Символьный код генерируется автоматически - это нормально!

Если при вводе `zec-crypto` в поле "Символьный код" он автоматически заменяется на `/catalog/asics/filter-zec-crypto/` - **это правильное поведение модуля**.

Модуль автоматически генерирует символьный код из поля "Новая ссылка".

## Главная задача: Правильно определить "Старую ссылку"

### Метод 1: Определение через браузер (РЕКОМЕНДУЕТСЯ)

1. **Откройте каталог ASICS в браузере:**
   ```
   https://ваш-домен.ru/catalog/asics/
   ```

2. **Откройте DevTools (F12) → Network (Сеть)**

3. **В фильтре на странице отметьте галочку "ZEC" в свойстве CRYPTO**

4. **Нажмите кнопку "Показать" или "Применить фильтр"**

5. **Посмотрите URL в адресной строке браузера**

   Правильный URL должен выглядеть примерно так:
   ```
   /catalog/asics/filter/crypto-is-zec/apply/
   ```
   
   Или возможны варианты:
   ```
   /catalog/asics/filter/crypto-eq-zec/apply/
   /catalog/asics/filter/property_crypto-is-zec/apply/
   /catalog/asics/filter/property_24-is-zec/apply/  (если CRYPTO имеет ID=24)
   ```

6. **СКОПИРУЙТЕ ЭТОТ URL ПОЛНОСТЬЮ** - это и есть ваша "Старая ссылка"!

### Метод 2: Проверка через JavaScript консоль

Если фильтр не применяется или URL не меняется, проверьте через консоль браузера (F12 → Console):

```javascript
// Вставьте этот код в консоль на странице /catalog/asics/
const smartFilter = document.querySelector('[data-filter]');
if (smartFilter) {
    console.log('Фильтр найден');
    
    // Отметьте галочку ZEC вручную и введите:
    const form = smartFilter.closest('form');
    console.log('Action формы:', form.action);
    console.log('Method формы:', form.method);
}
```

### Метод 3: Проверка структуры URL в коде

Стандартный формат URL фильтра Bitrix:
```
/catalog/[IBLOCK_CODE]/filter/[PROPERTY_CODE]-[OPERATOR]-[VALUE]/apply/
```

Где:
- `IBLOCK_CODE` = `asics`
- `PROPERTY_CODE` = код свойства (обычно в нижнем регистре)
- `OPERATOR` = оператор фильтрации (чаще всего `is` для "равно")
- `VALUE` = значение (в нижнем регистре)

**Примеры возможных вариантов для CRYPTO=ZEC:**

1. **Если свойство называется `CRYPTO`:**
   ```
   /catalog/asics/filter/crypto-is-zec/apply/
   ```

2. **Если используется префикс `property_`:**
   ```
   /catalog/asics/filter/property_crypto-is-zec/apply/
   ```

3. **Если свойство имеет ID (например, 24):**
   ```
   /catalog/asics/filter/property_24-is-zec/apply/
   ```

4. **Если значение ZEC - это элемент справочника:**
   ```
   /catalog/asics/filter/crypto-is-123/apply/  (где 123 - ID значения ZEC)
   ```

## Настройка записи в модуле

После определения "Старой ссылки" откройте запись "Крипта ZEC" в админке:

### Заполните поля:

**1. Вкладка "Информационный блок" → Название:**
```
Крипта ZEC
```

**2. Вкладка "Информационный блок" → Символьный код:**
```
(Оставьте пустым или введите любое значение - оно автоматически заменится)
```
⚠️ Модуль автоматически сгенерирует его из "Новой ссылки"

**3. Вкладка "Информационный блок" → Активность:**
```
✅ ВКЛЮЧИТЬ (галочка)
```

**4. Вкладка "Значения свойств" → Старая ссылка (без домена):**

**ВСТАВЬТЕ СЮДА URL, КОТОРЫЙ ВЫ СКОПИРОВАЛИ в Методе 1, например:**
```
/catalog/asics/filter/crypto-is-zec/apply/
```

⚠️ **КРИТИЧЕСКИ ВАЖНО:**
- URL должен быть **БЕЗ домена** (не `https://site.ru/...`, а только `/catalog/...`)
- URL должен начинается с `/` (слэша)
- URL должен заканчиваться на `/apply/` (если это формат вашего фильтра)

**5. Вкладка "Значения свойств" → Новая ссылка (без домена):**
```
/catalog/asics/filter-zec-crypto/
```
✅ Это красивый ЧПУ URL (оставить как есть)

**6. Вкладка "Значения свойств" → Редирект:**
```
301 Moved permanently
```

**7. Вкладка "Значения свойств" → Мета-тег robots:**
```
index, follow
```

**8. Вкладка "Значения свойств" → Генерировать все варианты умных ссылок для смарт-фильтра:**
```
✅ ВКЛЮЧИТЬ галочку
```

**9. Вкладка "Значения свойств" → Индексировать модулем поиска:**
```
✅ ВКЛЮЧИТЬ галочку
```

**10. Сохраните запись (кнопка "Сохранить")**

## После сохранения:

1. **Очистите кеш:**
   - Настройки → Производительность → Очистить кеш

2. **Проверьте работу:**
   - Откройте `/catalog/asics/filter-zec-crypto/`
   - Должны показываться только товары с CRYPTO=ZEC

## Если всё ещё не работает:

### Проблема 1: 404 ошибка при открытии `/catalog/asics/filter-zec-crypto/`

**Причина:** Модуль не перехватывает URL

**Решение:**
1. Проверьте, что модуль активен: Marketplace → Установленные решения → dwstroy.seochpulite (должен быть зелёный)
2. Проверьте наличие записи в инфоблоке с активностью "Да"
3. Убедитесь, что "Новая ссылка" = `/catalog/asics/filter-zec-crypto/`

### Проблема 2: Страница открывается, но показываются все товары (фильтр не применяется)

**Причина:** Неправильная "Старая ссылка"

**Решение:**
1. ❌ Удалите текущую запись "Крипта ZEC"
2. Откройте `/catalog/asics/` в браузере
3. Примените фильтр CRYPTO=ZEC вручную через интерфейс
4. **СКОПИРУЙТЕ ТОЧНЫЙ URL** из адресной строки
5. Создайте новую запись в модуле с этим URL в поле "Старая ссылка"

### Проблема 3: В адресной строке URL меняется на старый формат

**Это нормально!** Модуль делает **редирект 301**:
- Пользователь заходит на `/catalog/asics/filter-zec-crypto/`
- Модуль перенаправляет на `/catalog/asics/filter/crypto-is-zec/apply/`
- Фильтр применяется

Если нужно, чтобы URL оставался красивым, проверьте настройку "Редирект" в записи.

## Альтернативный способ: Логирование

Если ничего не помогает, добавьте логирование в `init.php`:

```php
// Добавьте в /local/php_interface/init.php

AddEventHandler("main", "OnBeforeProlog", function() {
    $uri = $_SERVER['REQUEST_URI'];
    
    if (strpos($uri, 'filter-zec-crypto') !== false) {
        $logFile = $_SERVER['DOCUMENT_ROOT'] . '/.gemini/seo_filter_debug.log';
        $logData = date('Y-m-d H:i:s') . "\n";
        $logData .= "Request URI: " . $uri . "\n";
        $logData .= "GET params: " . print_r($_GET, true) . "\n";
        $logData .= "POST params: " . print_r($_POST, true) . "\n";
        $logData .= "---\n";
        
        file_put_contents($logFile, $logData, FILE_APPEND);
    }
});
```

Затем:
1. Откройте `/catalog/asics/filter-zec-crypto/`
2. Посмотрите содержимое файла `/.gemini/seo_filter_debug.log`
3. Предоставьте содержимое этого файла

## Чеклист проверки:

- [ ] Определён точный "Старый URL" через браузер (примените фильтр вручную)
- [ ] В записи модуля "Старая ссылка" = точный URL из браузера
- [ ] В записи модуля "Новая ссылка" = `/catalog/asics/filter-zec-crypto/`
- [ ] Галочка "Генерировать все варианты" включена
- [ ] Запись активна (Активность = Да)
- [ ] Кеш Битрикс очищен
- [ ] URL `/catalog/asics/filter-zec-crypto/` открывается без 404
- [ ] Показываются только товары с CRYPTO=ZEC

---

**Если после всех шагов не работает, предоставьте:**
1. Точный URL из адресной строки после применения фильтра вручную
2. Скриншот всех вкладок формы записи "Крипта ZEC"
3. Результат диагностического скрипта `/local/tools/seo_filter_diagnostic.php`
